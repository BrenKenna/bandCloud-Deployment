<!DOCTYPE HTML>
<html lang="en">

    <head>
        <title>Multi Track / Mixing Tutorial</title>
    </head>
    
    
    <body>
    
        <button id="fetchTracks">Load Tracks</button>
        <br><br><br>
        <ul>
            <li id="bass">
                <a href="multi-track/bass_guitar.mp3">Bass Track</a>
                <!-- <button class="loadBtn" id="bassBtnLoad">Load</button> -->
                <button class="playBtn" id="bass">Play</button>
            </li>
            <br><br><br>

            <li id="guitar">
                <a href="multi-track/lead_guitar.mp3">Guitar Track</a>
                <!-- <button class="loadBtn" id="guitarBtnLoad">Load</button> -->
                <button class="playBtn" id="guitar">Play</button>
            </li>
            <br><br><br>

            <li id="drums">
                <a href="multi-track/drums.mp3">Drum Track</a>
                <!-- <button class="loadBtn" id="drumsBtnLoad">Load</button> -->
                <button class="playBtn" id="drums">Play</button>
            </li>
            <br><br><br>
        </ul>
        
        
        <!-- 
            The start button from their tutorial does quite a bit and is simplified by proceeding functions.

            Their start button also changes the state of tracks, by adding a play button that is an event listener

        -->
        <script type="text/javascript">
            
            // Clear console and setup audio Ctx for cross-browser
            // console.clear();
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            let audioCtx = null;
            
            
            /**
                Variables to manage events:
                    i). Tracks loaded
                    ii). Offset to synchronize playing tracks
            */
            let tracksLoaded = false;
            let offset = 0;
            
            
            // Get Major elements: Load Tracks, List items = tracks
            const startButton = document.querySelector("#fetchTracks");
            const trackElms = document.querySelectorAll("li");

            
            // Sanity check
            //console.log(`Start button = ${startButton}\n\nTracks:\n${trackElms}`)
        
            
            // Funtion to instantiate audio context
            function initAudio(){
                
                // Instantiate if not already
                if( !audioCtx) {
                    audioCtx = new AudioContext();
                }
            }
            
            // Async function to return an audio buffer from a url
            async function fetchFile(filepath) {
                
                // Await the request of array buffer
                const response = await fetch(filepath);
                const arrayBuffer = await response.arrayBuffer();
                
                // Decode array buffer to an audio buffer
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                
                // Return usable track
                return audioBuffer;
            }
            
            
            // Async function to call getting an audio buffer
            async function loadFile(filePath) {
                const track = await fetchFile(filePath);
                return track;
            }
            
            
            // Function to play tracks
            function playTrack(audioBuffer) {
                
                // Create an audio source node and add the input to it
                const trackSource = audioCtx.createBufferSource();
                trackSource.buffer = audioBuffer;
                
                // Connect the node to the audio context
                trackSource.connect(audioCtx.destination);
                
                
                // Handle where to start playing this track
                if ( offset == 0 ) {
                    
                    // From the top
                    trackSource.start();
                    offset = audioCtx.currentTime;
                    
                } else {
                    
                    // Via the offset
                    trackSource.start(0, (audioCtx.currentTime - offset) );
                }
                
                
                // Return the track
                return trackSource;
            }
            
            
            /** 
                Event Listeners for:
                    i). The start button.
                    ii). Play buttons
                    
                - Ignoring the separte loading buttons for now
            */
            
            // Event listener for the start button
            startButton.addEventListener('click', () => {
                
                // Handle the audio context
                initAudio();
                
                
                // Load all of the tracks
                trackElms.forEach( (elm, i) => {
                    
                    // Get the anchor & play button
                    const anchor = elm.querySelector("a");
                    const playButton = elm.querySelector(".playBtn");
                    // console.log(playButton)
                    
                    
                    // Manage the loadFile promise for an audioBuffer track
                    loadFile( anchor.href ).then( ( track ) => {
                        
                        // Add event listener to track
                        playButton.addEventListener('click', function() {
                            
                            // Manage the audio context state
                            console.log(`Hello! I am the ${playButton.id}`);
                            if( audioCtx.state == "suspended" ) {
                                audioCtx.resume;
                            }
                            
                            // Play the track
                            playTrack(track);
                        })
                    })
                })
                
                // Update tracks state
                tracksLoaded = true;
            });
        
        </script>
    </body>
</html>